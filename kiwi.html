<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>LINE Flex Auto from Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: sans-serif; padding: 1rem; background: #f5f5f5; }
      h1 { font-size: 1.1rem; margin-bottom: .5rem; }
      textarea { width: 100%; height: 280px; font-family: monospace; }
      button { margin-top: .5rem; padding: .5rem 1rem; }
      .row { margin-bottom: .7rem; }
      label { font-weight: bold; }

      /* preview styles */
      #preview {
        margin-top: 1rem;
        display: flex;
        gap: 1rem;
        overflow-x: auto;
      }
      .bubble {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,.08);
        width: 280px;
        padding: 12px 14px 14px 14px;
        flex: 0 0 auto;
      }
      .bubble-title {
        font-weight: 600;
        margin-bottom: 2px;
      }
      .bubble-date {
        font-size: 12px;
        color: #888;
        margin-bottom: 6px;
      }
      .bubble-sep {
        border-bottom: 1px solid #eee;
        margin: 6px 0 6px 0;
      }
      .bubble-name {
        font-size: 13px;
        line-height: 1.35;
        margin-bottom: 3px;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <h1>Duty Flex Generator <br/>(Sheet → Flex → Share)</h1>

    <!-- เลือกแหล่งข้อมูล (จริง ๆ ใช้ API เดียวกันทั้งคู่) -->
    <div class="row">
      <label>Source:</label>
      <select id="sourceSelect">
        <option value="day">เวรเช้า (KIWI_Version)</option>
        <option value="night">เวรเย็น (KIWI_Version)</option>
      </select>
    </div>

    <!-- เลือกเดือน -->
    <div class="row">
      <label>เลือกเดือน:</label>
      <select id="monthSelect">
        <option value="">-- เลือกเดือน --</option>
        <option value="เดือนพฤศจิกายน 2568">เดือนพฤศจิกายน 2568</option>
        <option value="เดือนธันวาคม 2568">เดือนธันวาคม 2568</option>
        <option value="เดือนมกราคม 2569">เดือนมกราคม 2569</option>
        <option value="เดือนกุมภาพันธ์ 2569">เดือนกุมภาพันธ์ 2569</option>
        <option value="เดือนมีนาคม 2569">เดือนมีนาคม 2569</option>
        <option value="เดือนเมษายน 2569">เดือนเมษายน 2569</option>
      </select>
    </div>

    <!-- เลือกวันที่ -->
    <div class="row">
      <label>เลือกวันที่:</label>
      <input type="number" id="dayInput" min="1" max="31" placeholder="เช่น 1" />
      <button id="btnLoad">Load & Build Flex</button>
    </div>

    <div class="row">
      <label>Generated Flex JSON:</label>
      <textarea id="flexOutput" spellcheck="false"></textarea>
    </div>

    <div class="row">
      <button id="btnShare">Share to LINE Target Picker</button>
    </div>

    <!-- HTML preview of Flex -->
    <div class="row">
      <label>Preview (HTML mock):</label>
      <div id="preview"></div>
    </div>

    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      // ====== CONFIG ======
      const LIFF_ID = "2008438278-VElJ5r8b";

      // ใช้ API ใหม่ KIWI_Version ทั้งสองตัวเลือก
      const DAY_URL   = "https://opensheet.elk.sh/1X2iwknZOpFErFyniArGdLCghwURp2Z3ERGMqlNSLPEI/KIWI_Version";
      const NIGHT_URL = "https://opensheet.elk.sh/1X2iwknZOpFErFyniArGdLCghwURp2Z3ERGMqlNSLPEI/KIWI_Version";

      // legend จุดเวร
      const POINT_LEGEND = [
        "[1] จุดที่ 1 ประตูหน้า (เช้า - เย็น)",
        "[2] จุดที่ 2 ประตูข้าง (เช้า - เย็น)",
        "[3] โรงจอดรถหลังอาคาร 6",
        "[4] โรงจอดรถหลังอาคาร 2"
      ];

      // ====== LIFF INIT ======
      async function initLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          console.log("LIFF init OK");
        } catch (err) {
          console.warn("LIFF init failed (still can view JSON):", err);
        }
      }

      // ====== FETCH & BUILD ======
      async function loadAndBuild() {
        const mode = document.getElementById("sourceSelect").value;
        const url = mode === "day" ? DAY_URL : NIGHT_URL;

        const monthBase = document.getElementById("monthSelect").value;
        const dayValRaw = document.getElementById("dayInput").value.trim();

        if (!monthBase) {
          alert("กรุณาเลือกเดือนก่อนนะครับ Sir");
          return;
        }
        if (!dayValRaw) {
          alert("กรุณากรอกวันที่ด้วยครับ Sir");
          return;
        }

        try {
          const res = await fetch(url);
          const data = await res.json(); // array of rows
          const flex = buildFlexForDate(data, monthBase, dayValRaw);
          document.getElementById("flexOutput").value = JSON.stringify(flex, null, 2);

          // render preview in HTML
          renderFlex(flex);
        } catch (err) {
          alert("Fetch/build error: " + err);
        }
      }

      // ====== BUILD ONE BUBBLE FLEX FOR SELECTED DATE ======
      function buildFlexForDate(rows, monthBase, dayVal) {
        const dateCol  = monthBase + " วันที่ยืนเวร";
        const pointCol = monthBase + " ประจำจุด";
        const targetDay = String(dayVal); // เปรียบเทียบเป็น string

        // เก็บ row ที่ตรงวันที่ก่อน แล้วค่อยไล่เลข 1.,2.,3,...
        const matches = [];

        rows.forEach(row => {
          const dateVal  = row[dateCol];
          const pointVal = row[pointCol];

          if (!dateVal || dateVal === "-" || !pointVal || pointVal === "-") return;
          if (String(dateVal) !== targetDay) return;

          matches.push({ row, pointVal });
        });

        const dutyLines = [];

        if (matches.length === 0) {
          dutyLines.push("ไม่มีผู้ปฏิบัติหน้าที่เวรในวันนี้");
        } else {
          matches.forEach((item, idx) => {
            const r = item.row;
            const pointVal = item.pointVal;
            const name     = r["ชื่อ-สกุล"] || "ไม่ระบุชื่อ";
            const position = r["ตำแหน่ง/กลุ่มสาระฯ"] || "";
            const no = idx + 1; // 1., 2., 3. ตามลำดับ
            dutyLines.push(`${no}. ${name} (${position}) จุด ${pointVal}`);
          });
        }

        const dutyBoxes = dutyLines.map(line => ({
          type: "text",
          text: line,
          size: "sm",
          wrap: true
        }));

        // legend จุดเวร
        const legendBoxes = POINT_LEGEND.map(line => ({
          type: "text",
          text: line,
          size: "xxs",
          wrap: true,
          color: "#555555"
        }));

        // ข้อความกำกับเพิ่มตามที่ Sir ขอ
        const noteBoxes = [
          {
            type: "text",
            text: "- กำหนดลงเวลาปฏิบัติหน้าที่เวรแต่ละจุด ไม่เกิน 07.00 น. และปฏิบัติหน้าที่เวรตอนเย็น 15.30-16.00 น.",
            size: "xxs",
            wrap: true,
            color: "#666666",
            margin: "md"
          },
          {
            type: "text",
            text: "- ปฏิบัติหน้าที่เวร แต่ละจุด จนถึงเวลา 07.50 น. จากนั้นให้ไปปฏิบัติครูที่ปรึกษาควบคุมดูแลแถวนักเรียนในกิจกรรมหน้าเสาธง",
            size: "xxs",
            wrap: true,
            color: "#666666"
          }
        ];

        const headerText = `ตารางเวร วันที่ ${targetDay} ${monthBase}`;

        // ONE bubble (not carousel)
        const bubble = {
          type: "bubble",
          size: "mega",
          body: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              {
                type: "text",
                text: headerText,
                weight: "bold",
                size: "md",
                wrap: true
              },
              {
                type: "box",
                layout: "vertical",
                spacing: "xs",
                contents: [
                  // รายชื่อเวร
                  ...dutyBoxes,
                  // เส้นคั่นก่อน legend + กติกา
                  {
                    type: "separator",
                    margin: "md"
                  },
                  // legend จุดเวร
                  ...legendBoxes,
                  // กติกาเวร
                  ...noteBoxes
                ]
              }
            ]
          }
        };

        return bubble;
      }

      // ====== HTML PREVIEW (support bubble OR carousel) ======
      function renderFlex(flex) {
        const preview = document.getElementById("preview");
        preview.innerHTML = "";

        let bubbles = [];

        if (flex && flex.type === "carousel" && Array.isArray(flex.contents)) {
          bubbles = flex.contents;
        } else if (flex && flex.type === "bubble") {
          bubbles = [flex];
        } else {
          preview.textContent = "No preview.";
          return;
        }

        bubbles.slice(0, 5).forEach(bubble => {
          const bubbleEl = document.createElement("div");
          bubbleEl.className = "bubble";

          const body = bubble.body || {};
          const contents = body.contents || [];

          const title = contents.find(c => c.type === "text" && c.weight === "bold");
          const detailBox = contents.find(c => c.type === "box" && Array.isArray(c.contents));

          bubbleEl.innerHTML = `
            <div class="bubble-title">${title ? title.text : "ตารางเวร"}</div>
            <div class="bubble-sep"></div>
          `;

          if (detailBox) {
            detailBox.contents.forEach(n => {
              if (!n.text) return;
              const p = document.createElement("div");
              p.className = "bubble-name";
              p.textContent = n.text;
              bubbleEl.appendChild(p);
            });
          }

          preview.appendChild(bubbleEl);
        });
      }

      // ====== SHARE ======
      async function shareFlex() {
        const raw = document.getElementById("flexOutput").value.trim();
        if (!raw) {
          alert("No JSON to share yet, Sir. Press 'Load & Build Flex' first.");
          return;
        }
        let flexJson;
        try {
          flexJson = JSON.parse(raw);
        } catch (err) {
          alert("JSON not valid, Sir: " + err);
          return;
        }

        if (!liff.isInClient()) {
          alert("Please open in LINE app to use Target Picker.");
          return;
        }

        try {
          await liff.shareTargetPicker([
            {
              type: "flex",
              altText: "ตารางเวร",
              contents: flexJson
            }
          ]);
        } catch (err) {
          alert("Share failed: " + err);
        }
      }

      // ====== EVENT BINDINGS ======
      document.addEventListener("DOMContentLoaded", () => {
        initLiff();
        document.getElementById("btnLoad").addEventListener("click", loadAndBuild);
        document.getElementById("btnShare").addEventListener("click", shareFlex);
      });
    </script>
  </body>
</html>
