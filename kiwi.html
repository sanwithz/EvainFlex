<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>LINE Flex Auto from Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: sans-serif; padding: 1rem; background: #f5f5f5; }
      h1 { font-size: 1.1rem; margin-bottom: .5rem; }
      textarea { width: 100%; height: 280px; font-family: monospace; }
      button { margin-top: .5rem; padding: .5rem 1rem; }
      .row { margin-bottom: .7rem; }
      label { font-weight: bold; }

      /* preview styles */
      #preview {
        margin-top: 1rem;
        display: flex;
        gap: 1rem;
        overflow-x: auto;
      }
      .bubble {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,.08);
        width: 280px;
        padding: 12px 14px 14px 14px;
        flex: 0 0 auto;
      }
      .bubble-title {
        font-weight: 600;
        margin-bottom: 2px;
      }
      .bubble-sep {
        border-bottom: 1px solid #eee;
        margin: 6px 0 6px 0;
      }
      .bubble-name {
        font-size: 13px;
        line-height: 1.35;
        margin-bottom: 3px;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <h1>Duty Flex Generator <br/>(Sheet ‚Üí Flex ‚Üí Share)</h1>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà) -->
    <div class="row">
      <label>Source:</label>
      <select id="sourceSelect">
        <option value="day">‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤ (KIWI_Version)</option>
        <option value="night">‡πÄ‡∏ß‡∏£‡πÄ‡∏¢‡πá‡∏ô (KIWI_Version)</option>
      </select>
    </div>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
    <div class="row">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <select id="monthSelect">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô --</option>
        <option value="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2568">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2568</option>
        <option value="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568</option>
        <option value="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2569">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2569</option>
        <option value="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</option>
        <option value="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2569">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2569</option>
        <option value="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô 2569">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô 2569</option>
      </select>
    </div>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
    <div class="row">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
      <select id="dayInput">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        <option value="27">27</option>
        <option value="28">28</option>
        <option value="29">29</option>
        <option value="30">30</option>
        <option value="31">31</option>
      </select>
      <button id="btnLoad">Load & Build Flex</button>
    </div>

    <div class="row">
      <label>Generated Flex JSON:</label>
      <textarea id="flexOutput" spellcheck="false"></textarea>
    </div>

    <div class="row">
      <button id="btnShare">Share to LINE Target Picker</button>
    </div>

    <!-- HTML preview of Flex -->
    <div class="row">
      <label>Preview (HTML mock):</label>
      <div id="preview"></div>
    </div>

    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      // ====== CONFIG ======
      const LIFF_ID = "2008438278-VElJ5r8b";

      // ‡πÉ‡∏ä‡πâ API ‡πÉ‡∏´‡∏°‡πà KIWI_Version ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const DAY_URL   = "https://opensheet.elk.sh/1X2iwknZOpFErFyniArGdLCghwURp2Z3ERGMqlNSLPEI/KIWI_Version";
      const NIGHT_URL = "https://opensheet.elk.sh/1X2iwknZOpFErFyniArGdLCghwURp2Z3ERGMqlNSLPEI/KIWI_Version";

      // legend ‡∏à‡∏∏‡∏î‡πÄ‡∏ß‡∏£ (‡∏ï‡∏≤‡∏° Flex ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
      const POINT_LEGEND = [
        "üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏ä‡πâ‡∏≤ - ‡πÄ‡∏¢‡πá‡∏ô)",
        "üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Ç‡πâ‡∏≤‡∏á (‡πÄ‡∏ä‡πâ‡∏≤ - ‡πÄ‡∏¢‡πá‡∏ô)",
        "üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 3 ‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 6",
        "üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 4 ‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 2"
      ];

      // ====== LIFF INIT ======
      async function initLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          console.log("LIFF init OK");
        } catch (err) {
          console.warn("LIFF init failed (still can view JSON):", err);
        }
      }

      // ====== FETCH & BUILD ======
      async function loadAndBuild() {
        const mode = document.getElementById("sourceSelect").value;
        const url = mode === "day" ? DAY_URL : NIGHT_URL;

        const monthBase = document.getElementById("monthSelect").value;
        const dayValRaw = document.getElementById("dayInput").value.trim();

        if (!monthBase) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö Sir");
          return;
        }
        if (!dayValRaw) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö Sir");
          return;
        }

        try {
          const res = await fetch(url);
          const data = await res.json(); // array of rows
          const flex = buildFlexForDate(data, monthBase, dayValRaw);
          document.getElementById("flexOutput").value = JSON.stringify(flex, null, 2);

          // render preview in HTML
          renderFlex(flex);
        } catch (err) {
          alert("Fetch/build error: " + err);
        }
      }

      // ====== BUILD ONE BUBBLE FLEX FOR SELECTED DATE (MATCH TEMPLATE) ======
      function buildFlexForDate(rows, monthBase, dayVal) {
        const dateCol  = monthBase + " ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡πÄ‡∏ß‡∏£";
        const pointCol = monthBase + " ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î";
        const targetDay = String(dayVal);

        const matches = [];

        rows.forEach(row => {
          const dateVal  = row[dateCol];
          const pointVal = row[pointCol];

          if (!dateVal || dateVal === "-" || !pointVal || pointVal === "-") return;
          if (String(dateVal) !== targetDay) return;

          matches.push({ row, pointVal });
        });

        // üëâ SORT BY pointVal: 1, 2, 3, 4
        matches.sort((a, b) => {
          const pa = parseInt(a.pointVal, 10);
          const pb = parseInt(b.pointVal, 10);
          if (isNaN(pa) && isNaN(pb)) return 0;
          if (isNaN(pa)) return 1;
          if (isNaN(pb)) return -1;
          return pa - pb;
        });

        const dutyLines = [];

        if (matches.length === 0) {
          dutyLines.push("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
        } else {
          matches.forEach((item, idx) => {
            const r = item.row;
            const pointVal = item.pointVal;
            const name     = r["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠";
            const position = r["‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø"] || "";
            const no = idx + 1;
            dutyLines.push(`${no}. ${name} (${position}) ‡∏à‡∏∏‡∏î ${pointVal}`);
          });
        }

        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏£
        const dutyBoxes = dutyLines.map(line => ({
          type: "text",
          text: line,
          size: "sm",
          wrap: true
        }));

        // legend ‡∏à‡∏∏‡∏î‡πÄ‡∏ß‡∏£ (üìç) ‚Äî first line margin md
        const legendBoxes = POINT_LEGEND.map((line, idx) => {
          const obj = {
            type: "text",
            text: line,
            size: "sm",
            wrap: true
          };
          if (idx === 0) obj.margin = "md";
          return obj;
        });

        // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ß‡∏£ 4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡∏ï‡∏≤‡∏° Flex ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        const noteBoxes = [
          {
            type: "text",
            text: "- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 07.00 ‡∏ô.",
            margin: "md",
            size: "sm",
            wrap: true
          },
          {
            type: "text",
            text: "- ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏£ ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 07.50 ‡∏ô. ",
            size: "sm",
            wrap: true
          },
          {
            type: "text",
            text: "- ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏£‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô 15.30-16.00 ‡∏ô.",
            size: "sm",
            wrap: true
          },
          {
            type: "text",
            text: "- ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô \n‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á",
            size: "sm",
            wrap: true
          }
        ];

        const headerText = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${targetDay} ${monthBase}`;

        // inner box contents = duty list + separator + legend + separator + rules
        const innerContents = [
          ...dutyBoxes,
          {
            type: "separator",
            margin: "md"
          },
          ...legendBoxes,
          {
            type: "separator",
            margin: "md"
          },
          ...noteBoxes
        ];

        // FLEX BUBBLE EXACTLY LIKE GIVEN TEMPLATE
        const bubble = {
          type: "bubble",
          size: "giga",
          body: {
            type: "box",
            layout: "vertical",
            paddingAll: "16px",
            contents: [
              {
                type: "text",
                text: headerText,
                weight: "bold",
                size: "lg",
                align: "center",
                wrap: true
              },
              {
                type: "separator",
                margin: "md"
              },
              {
                type: "box",
                layout: "vertical",
                margin: "md",
                spacing: "xs",
                contents: innerContents
              }
            ]
          },
          styles: {
            body: {
              backgroundColor: "#FFFFFF"
            }
          }
        };

        return bubble;
      }

      // ====== HTML PREVIEW (support bubble OR carousel) ======
      function renderFlex(flex) {
        const preview = document.getElementById("preview");
        preview.innerHTML = "";

        let bubbles = [];

        if (flex && flex.type === "carousel" && Array.isArray(flex.contents)) {
          bubbles = flex.contents;
        } else if (flex && flex.type === "bubble") {
          bubbles = [flex];
        } else {
          preview.textContent = "No preview.";
          return;
        }

        bubbles.slice(0, 5).forEach(bubble => {
          const bubbleEl = document.createElement("div");
          bubbleEl.className = "bubble";

          const body = bubble.body || {};
          const contents = body.contents || [];

          const title = contents.find(c => c.type === "text" && c.weight === "bold");
          const detailBox = contents.find(c => c.type === "box" && Array.isArray(c.contents));

          bubbleEl.innerHTML = `
            <div class="bubble-title">${title ? title.text : "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£"}</div>
            <div class="bubble-sep"></div>
          `;

          if (detailBox) {
            detailBox.contents.forEach(n => {
              if (!n.text) return;
              const p = document.createElement("div");
              p.className = "bubble-name";
              p.textContent = n.text;
              bubbleEl.appendChild(p);
            });
          }

          preview.appendChild(bubbleEl);
        });
      }

      // ====== SHARE ======
      async function shareFlex() {
        const raw = document.getElementById("flexOutput").value.trim();
        if (!raw) {
          alert("No JSON to share yet, Sir. Press 'Load & Build Flex' first.");
          return;
        }
        let flexJson;
        try {
          flexJson = JSON.parse(raw);
        } catch (err) {
          alert("JSON not valid, Sir: " + err);
          return;
        }

        if (!liff.isInClient()) {
          alert("Please open in LINE app to use Target Picker.");
          return;
        }

        try {
          await liff.shareTargetPicker([
            {
              type: "flex",
              altText: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£",
              contents: flexJson
            }
          ]);
        } catch (err) {
          alert("Share failed: " + err);
        }
      }

      // ====== EVENT BINDINGS ======
      document.addEventListener("DOMContentLoaded", () => {
        initLiff();
        document.getElementById("btnLoad").addEventListener("click", loadAndBuild);
        document.getElementById("btnShare").addEventListener("click", shareFlex);
      });
    </script>
  </body>
</html>
